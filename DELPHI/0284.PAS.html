<html>
<head><title> "Component wraps the Win95 PageSetupDlg c" by BRAD STOWERS</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center">
<b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;
<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;
<b>[</b><a href="0284.PAS">Original</a><b>]</b>&nbsp;&nbsp;
<b>[</b><a href="0284.ATTACH.ZIP">Attachment</a><b>]</b>

</p><!--StartFragment--><pre><code><font color="#008000"><i>{ NOTE DCR AND DEMO located at the END of this unit }

{-----------------------------------------------------------------------------}
{ A component to wrap the Win95 PageSetupDlg common dialog API function.      }
{ Borland seems to have forgotten this new common dialog in Delphi 2.0.       }
{ Copyright 1996, Brad Stowers.  All Rights Reserved.                         }
{ This component can be freely used and distributed in commercial and private }
{ environments, provided this notice is not modified in any way and there is  }
{ no charge for it other than nominal handling fees.  Contact me directly for }
{ modifications to this agreement.                                            }
{-----------------------------------------------------------------------------}
{ Feel free to contact me if you have any questions, comments or suggestions  }
{ at bstowers@pobox.com or 72733,3374 on CompuServe.                          }
{ The lateset version will always be available on the web at:                 }
{   http://www.pobox.com/~bstowers/delphi/                                    }
{-----------------------------------------------------------------------------}
{ Date last modified:  08/27/96                                               }
{-----------------------------------------------------------------------------}

{ ----------------------------------------------------------------------------}
{ TPageSetupDialog v1.00                                                      }
{ ----------------------------------------------------------------------------}
{ Description:                                                                }
{   A component to wrap the PageSetupDlg API function that Borland forgot.    }
{   It is a common dialog available on the Win95 platform, so it can not be   }
{   used with Delphi 1.0.                                                     }
{ ----------------------------------------------------------------------------}
{ Revision History:                                                           }
{ 1.00:  + Initial release.                                                   }
{ ----------------------------------------------------------------------------}

</i></font><font color="#FF0000"><b>unit </b></font>PgSetup<font color="#000080">;

</font><font color="#FF0000"><b>interface

</b></font><font color="#008000"><i>{$IFNDEF WIN32}
  </i></font>ERROR<font color="#000080">!  </font>This <font color="#FF0000"><b>unit </b></font>only available <font color="#FF0000"><b>for </b></font>Delphi <font color="#800000">2.0</font><font color="#000080">!!!
</font><font color="#008000"><i>{$ENDIF}

</i></font><font color="#FF0000"><b>uses
  </b></font>Windows<font color="#000080">, </font>Messages<font color="#000080">, </font>SysUtils<font color="#000080">, </font>Classes<font color="#000080">, </font>Graphics<font color="#000080">, </font>Controls<font color="#000080">, </font>Forms<font color="#000080">, </font>Dialogs<font color="#000080">,
  </font>CommDlg<font color="#000080">, </font>DsgnIntf<font color="#000080">;

</font><font color="#FF0000"><b>type
  </b></font>TPageSetupOption <font color="#000080">= (
       </font>poDefaultMinMargins<font color="#000080">, </font>poDisableMargins<font color="#000080">, </font>poDisableOrientation<font color="#000080">,
       </font>poDisablePagePainting<font color="#000080">, </font>poDisablePaper<font color="#000080">, </font>poDisablePrinter<font color="#000080">, </font>poNoWarning<font color="#000080">, </font>poShowHelp
     <font color="#000080">);
  </font>TPageSetupOptions <font color="#000080">= </font><font color="#FF0000"><b>set of </b></font>TPageSetupOption<font color="#000080">;
  </font>TPSPaperType <font color="#000080">= (</font>ptPaper<font color="#000080">, </font>ptEnvelope<font color="#000080">);
  </font>TPSPaperOrientation <font color="#000080">= (</font>poPortrait<font color="#000080">, </font>poLandscape<font color="#000080">);
  </font>TPSPrinterType <font color="#000080">= (</font>ptDotMatrix<font color="#000080">, </font>ptHPPCL<font color="#000080">);
  </font>TPSPaintWhat <font color="#000080">= (</font>pwFullPage<font color="#000080">, </font>pwMinimumMargins<font color="#000080">, </font>pwMargins<font color="#000080">,
                  </font>pwGreekText<font color="#000080">, </font>pwEnvStamp<font color="#000080">, </font>pwYAFullPage<font color="#000080">);

  </font>TPSMeasurements <font color="#000080">= (</font>pmMillimeters<font color="#000080">, </font>pmInches<font color="#000080">);
  </font>TPSPrinterEvent <font color="#000080">= </font><font color="#FF0000"><b>procedure</b></font><font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">; </font>Wnd<font color="#000080">: </font>HWND<font color="#000080">) </font><font color="#FF0000"><b>of object</b></font><font color="#000080">;

  </font><font color="#008000"><i>{ PPSDlgData is simply redeclared as PPageSetupDlg (COMMDLG.PAS) to prevent compile }
  { errors in units that have this event.  They won't compile unless you add CommDlg  }
  { to their units.  This circumvents the problem.                                    }
  </i></font>PPSDlgData <font color="#000080">= ^</font>TPSDlgData<font color="#000080">;
  </font>TPSDlgData <font color="#000080">= </font>TPageSetupDlg<font color="#000080">;
  </font><font color="#008000"><i>{ PaperSize: See DEVMODE help topic, dmPaperSize member. DMPAPER_* constants. }
  </i></font>TPSInitPaintPageEvent <font color="#000080">= </font><font color="#FF0000"><b>function</b></font><font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">; </font>PaperSize<font color="#000080">: </font>short<font color="#000080">;
              </font>PaperType<font color="#000080">: </font>TPSPaperType<font color="#000080">; </font>PaperOrientation<font color="#000080">: </font>TPSPaperOrientation<font color="#000080">;
              </font>PrinterType<font color="#000080">: </font>TPSPrinterType<font color="#000080">; </font>pSetupData<font color="#000080">: </font>PPSDlgData<font color="#000080">): </font>boolean <font color="#FF0000"><b>of object</b></font><font color="#000080">;
  </font>TPSPaintPageEvent <font color="#000080">= </font><font color="#FF0000"><b>function</b></font><font color="#000080">(</font>Sender<font color="#000080">: </font>TObject<font color="#000080">; </font>PaintWhat<font color="#000080">: </font>TPSPaintWhat<font color="#000080">;
              </font>Canvas<font color="#000080">: </font>TCanvas<font color="#000080">; </font>Rect<font color="#000080">: </font>TRect<font color="#000080">): </font>boolean <font color="#FF0000"><b>of object</b></font><font color="#000080">;


  </font>TPageSetupDialog <font color="#000080">= </font><font color="#FF0000"><b>class</b></font><font color="#000080">(</font>TCommonDialog<font color="#000080">)
  </font><font color="#FF0000"><b>private
    </b></font>FOptions<font color="#000080">: </font>TPageSetupOptions<font color="#000080">;
    </font>FCustomData<font color="#000080">: </font>LPARAM<font color="#000080">;
    </font>FPaperSize<font color="#000080">: </font>TPoint<font color="#000080">;
    </font>FMinimumMargins<font color="#000080">: </font>TRect<font color="#000080">;
    </font>FMargins<font color="#000080">: </font>TRect<font color="#000080">;
    </font>FMeasurements<font color="#000080">: </font>TPSMeasurements<font color="#000080">;
    </font>FOnPrinter<font color="#000080">: </font>TPSPrinterEvent<font color="#000080">;
    </font>FOnInitPaintPage<font color="#000080">: </font>TPSInitPaintPageEvent<font color="#000080">;
    </font>FOnPaintPage<font color="#000080">: </font>TPSPaintPageEvent<font color="#000080">;

    </font><font color="#FF0000"><b>function </b></font>DoPrinter<font color="#000080">(</font>Wnd<font color="#000080">: </font>HWND<font color="#000080">): </font>boolean<font color="#000080">;
    </font><font color="#FF0000"><b>function </b></font>DoExecute<font color="#000080">(</font>Func<font color="#000080">: </font>pointer<font color="#000080">): </font>boolean<font color="#000080">;
  </font><font color="#FF0000"><b>protected
    function </b></font>Printer<font color="#000080">(</font>Wnd<font color="#000080">: </font>HWND<font color="#000080">): </font>boolean<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>public
    constructor </b></font>Create<font color="#000080">(</font>AOwner<font color="#000080">: </font>TComponent<font color="#000080">); </font><font color="#FF0000"><b>override</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>destructor </b></font>Destroy<font color="#000080">; </font><font color="#FF0000"><b>override</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>function </b></font>Execute<font color="#000080">: </font>boolean<font color="#000080">; </font><font color="#FF0000"><b>virtual</b></font><font color="#000080">;
    </font><font color="#008000"><i>{ It is the user's responsibility to clean up this pointer if necessary. }
    </i></font><font color="#FF0000"><b>property </b></font>CustomData<font color="#000080">: </font>LPARAM
        <font color="#FF0000"><b>read </b></font>FCustomData
        <font color="#FF0000"><b>write </b></font>FCustomData<font color="#000080">;

    </font><font color="#008000"><i>{ These should be published, but need Property Editors for TPoint and TRect.  As }
    { best I can tell, there is no way to do that, since they need RTTI, and that is }
    { not available for record types.  Bummer.                                       }
    { Also, all of these rects return sizes that need to be divided by 1000.  For    }
    { example, PaperSize.X would be 8500 for 8.5 inch paper.  Maybe I should make a  }
    { TSingleRect and TSinglePoint and return the actual single value, but the API   }
    { returns them to me that way, and I'm lazy by default. :)                       }
    </i></font><font color="#FF0000"><b>property </b></font>PaperSize<font color="#000080">: </font>TPoint
        <font color="#FF0000"><b>read </b></font>FPaperSize
        <font color="#FF0000"><b>write </b></font>FPaperSize<font color="#000080">;
    </font><font color="#FF0000"><b>property </b></font>MinimumMargins<font color="#000080">: </font>TRect
        <font color="#FF0000"><b>read </b></font>FMinimumMargins
        <font color="#FF0000"><b>write </b></font>FMinimumMargins<font color="#000080">;
    </font><font color="#FF0000"><b>property </b></font>Margins<font color="#000080">: </font>TRect
        <font color="#FF0000"><b>read </b></font>FMargins
        <font color="#FF0000"><b>write </b></font>FMargins<font color="#000080">;

  </font><font color="#FF0000"><b>published
    property </b></font>Options<font color="#000080">: </font>TPageSetupOptions
        <font color="#FF0000"><b>read </b></font>FOptions
        <font color="#FF0000"><b>write </b></font>FOptions
        <font color="#FF0000"><b>default </b></font><font color="#000080">[</font>poDefaultMinMargins<font color="#000080">, </font>poShowHelp<font color="#000080">];
    </font><font color="#FF0000"><b>property </b></font>Measurements<font color="#000080">: </font>TPSMeasurements
        <font color="#FF0000"><b>read </b></font>FMeasurements
        <font color="#FF0000"><b>write </b></font>FMeasurements
        <font color="#FF0000"><b>default </b></font>pmInches<font color="#000080">;

    </font><font color="#008000"><i>{ Events }
    </i></font><font color="#FF0000"><b>property </b></font>OnPrinter<font color="#000080">: </font>TPSPrinterEvent
        <font color="#FF0000"><b>read </b></font>FOnPrinter
        <font color="#FF0000"><b>write </b></font>FOnPrinter<font color="#000080">;
    </font><font color="#FF0000"><b>property </b></font>OnInitPaintPage<font color="#000080">: </font>TPSInitPaintPageEvent
        <font color="#FF0000"><b>read </b></font>FOnInitPaintPage
        <font color="#FF0000"><b>write </b></font>FOnInitPaintPage<font color="#000080">;
    </font><font color="#FF0000"><b>property </b></font>OnPaintPage<font color="#000080">: </font>TPSPaintPageEvent
        <font color="#FF0000"><b>read </b></font>FOnPaintPage
        <font color="#FF0000"><b>write </b></font>FOnPaintPage<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure Register</b></font><font color="#000080">;

</font><font color="#FF0000"><b>implementation

uses </b></font>Printers<font color="#000080">;

</font><font color="#FF0000"><b>const
  </b></font>IDPRINTERBTN <font color="#000080">= </font><font color="#800000">$0402</font><font color="#000080">;

</font><font color="#008000"><i>{ Private globals }
</i></font><font color="#FF0000"><b>var
  </b></font>HelpMsg<font color="#000080">: </font>Integer<font color="#000080">;
  </font>HookCtl3D<font color="#000080">: </font>boolean<font color="#000080">;


</font><font color="#008000"><i>{ Center the given window on the screen }
</i></font><font color="#FF0000"><b>procedure </b></font>CenterWindow<font color="#000080">(</font>Wnd<font color="#000080">: </font>HWnd<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>Rect<font color="#000080">: </font>TRect<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>GetWindowRect<font color="#000080">(</font>Wnd<font color="#000080">, </font>Rect<font color="#000080">);
  </font>SetWindowPos<font color="#000080">(</font>Wnd<font color="#000080">, </font><font color="#800000">0</font><font color="#000080">,
    (</font>GetSystemMetrics<font color="#000080">(</font>SM_CXSCREEN<font color="#000080">) - </font>Rect<font color="#000080">.</font>Right <font color="#000080">+ </font>Rect<font color="#000080">.</font>Left<font color="#000080">) </font><font color="#FF0000"><b>div </b></font><font color="#800000">2</font><font color="#000080">,
    (</font>GetSystemMetrics<font color="#000080">(</font>SM_CYSCREEN<font color="#000080">) - </font>Rect<font color="#000080">.</font>Bottom <font color="#000080">+ </font>Rect<font color="#000080">.</font>Top<font color="#000080">) </font><font color="#FF0000"><b>div </b></font><font color="#800000">3</font><font color="#000080">,
    </font><font color="#800000">0</font><font color="#000080">, </font><font color="#800000">0</font><font color="#000080">, </font>SWP_NOACTIVATE <font color="#FF0000"><b>or </b></font>SWP_NOSIZE <font color="#FF0000"><b>or </b></font>SWP_NOZORDER<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ Generic dialog hook. Centers the dialog on the screen in response to
  the WM_INITDIALOG message }
</i></font><font color="#FF0000"><b>function </b></font>DialogHook<font color="#000080">(</font>Wnd<font color="#000080">: </font>HWnd<font color="#000080">; </font>Msg<font color="#000080">: </font>UINT<font color="#000080">; </font>WParam<font color="#000080">: </font>WPARAM<font color="#000080">; </font>LParam<font color="#000080">: </font>LPARAM<font color="#000080">): </font>UINT<font color="#000080">; </font><font color="#FF0000"><b>stdcall</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Result <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>case </b></font>Msg <font color="#FF0000"><b>of
    </b></font>WM_INITDIALOG<font color="#000080">:
      </font><font color="#FF0000"><b>begin
        if </b></font>HookCtl3D <font color="#FF0000"><b>then
        begin
          </b></font>Subclass3DDlg<font color="#000080">(</font>Wnd<font color="#000080">, </font>CTL3D_ALL<font color="#000080">);
          </font>SetAutoSubClass<font color="#000080">(</font>True<font color="#000080">);
        </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font>CenterWindow<font color="#000080">(</font>Wnd<font color="#000080">);
        </font>Result <font color="#000080">:= </font><font color="#800000">1</font><font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font>WM_DESTROY<font color="#000080">:
      </font><font color="#FF0000"><b>if </b></font>HookCtl3D <font color="#FF0000"><b>then </b></font>SetAutoSubClass<font color="#000080">(</font>False<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>var
  </b></font>PageSetupDialog<font color="#000080">: </font>TPageSetupDialog<font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>PageSetupDialogHook<font color="#000080">(</font>Wnd<font color="#000080">: </font>HWnd<font color="#000080">; </font>Msg<font color="#000080">: </font>UINT<font color="#000080">; </font>WParam<font color="#000080">: </font>WPARAM<font color="#000080">;
                             </font>LParam<font color="#000080">: </font>LPARAM<font color="#000080">): </font>UINT<font color="#000080">; </font><font color="#FF0000"><b>stdcall</b></font><font color="#000080">;
</font><font color="#FF0000"><b>const
  </b></font>PagePaintWhat<font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font>WM_PSD_FULLPAGERECT<font color="#000080">..
                       </font>WM_PSD_YAFULLPAGERECT<font color="#000080">] </font><font color="#FF0000"><b>of </b></font>TPSPaintWhat <font color="#000080">= (
    </font>pwFullPage<font color="#000080">, </font>pwMinimumMargins<font color="#000080">, </font>pwMargins<font color="#000080">,
    </font>pwGreekText<font color="#000080">, </font>pwEnvStamp<font color="#000080">, </font>pwYAFullPage
  <font color="#000080">);
  </font>PRINTER_MASK <font color="#000080">= </font><font color="#800000">$00000002</font><font color="#000080">;
  </font>ORIENT_MASK  <font color="#000080">= </font><font color="#800000">$00000004</font><font color="#000080">;
  </font>PAPER_MASK   <font color="#000080">= </font><font color="#800000">$00000008</font><font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>PaperData<font color="#000080">: </font>word<font color="#000080">;
  </font>Paper<font color="#000080">: </font>TPSPaperType<font color="#000080">;
  </font>Orient<font color="#000080">: </font>TPSPaperOrientation<font color="#000080">;
  </font>Printer<font color="#000080">: </font>TPSPrinterType<font color="#000080">;
  </font>PaintRect<font color="#000080">: </font>TRect<font color="#000080">;
  </font>PaintCanvas<font color="#000080">: </font>TCanvas<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font><font color="#000080">(</font>Msg <font color="#000080">= </font>WM_COMMAND<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>LongRec<font color="#000080">(</font>WParam<font color="#000080">).</font>Lo <font color="#000080">= </font>IDPRINTERBTN<font color="#000080">) </font><font color="#FF0000"><b>and
     </b></font><font color="#000080">(</font>LongRec<font color="#000080">(</font>WParam<font color="#000080">).</font>Hi <font color="#000080">= </font>BN_CLICKED<font color="#000080">) </font><font color="#FF0000"><b>then begin
    </b></font><font color="#008000"><i>// if hander is assigned, use it.  If not, let system do it.
    </i></font>Result <font color="#000080">:= </font>ord<font color="#000080">(</font>PageSetupDialog<font color="#000080">.</font>DoPrinter<font color="#000080">(</font>Wnd<font color="#000080">));
  </font><font color="#FF0000"><b>end else begin
    if </b></font>assigned<font color="#000080">(</font>PageSetupDialog<font color="#000080">.</font>FOnInitPaintPage<font color="#000080">) </font><font color="#FF0000"><b>and
           </b></font>assigned<font color="#000080">(</font>PageSetupDialog<font color="#000080">.</font>FOnPaintPage<font color="#000080">) </font><font color="#FF0000"><b>then begin
      case </b></font>Msg <font color="#FF0000"><b>of
        </b></font>WM_PSD_PAGESETUPDLG<font color="#000080">:
          </font><font color="#FF0000"><b>begin
            </b></font>PaperData <font color="#000080">:= </font>HiWord<font color="#000080">(</font>WParam<font color="#000080">);
            </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>PaperData <font color="#FF0000"><b>AND </b></font>PAPER_MASK <font color="#000080">&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
              </b></font>Paper <font color="#000080">:= </font>ptEnvelope
            <font color="#FF0000"><b>else
              </b></font>Paper <font color="#000080">:= </font>ptPaper<font color="#000080">;
            </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>PaperData <font color="#FF0000"><b>AND </b></font>ORIENT_MASK <font color="#000080">&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
              </b></font>Orient <font color="#000080">:= </font>poPortrait
            <font color="#FF0000"><b>else
              </b></font>Orient <font color="#000080">:= </font>poLandscape<font color="#000080">;
            </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>PaperData <font color="#FF0000"><b>AND </b></font>PAPER_MASK <font color="#000080">&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then
              </b></font>Printer <font color="#000080">:= </font>ptHPPCL
            <font color="#FF0000"><b>else
              </b></font>Printer <font color="#000080">:= </font>ptDotMatrix<font color="#000080">;
            </font>Result <font color="#000080">:= </font>Ord<font color="#000080">(</font>PageSetupDialog<font color="#000080">.</font>FOnInitPaintPage<font color="#000080">(</font>PageSetupDialog<font color="#000080">,
                </font>LoWord<font color="#000080">(</font>WParam<font color="#000080">), </font>Paper<font color="#000080">, </font>Orient<font color="#000080">, </font>Printer<font color="#000080">, </font>PPSDlgData<font color="#000080">(</font>LParam<font color="#000080">)));
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
        </font>WM_PSD_FULLPAGERECT<font color="#000080">,
        </font>WM_PSD_MINMARGINRECT<font color="#000080">,
        </font>WM_PSD_MARGINRECT<font color="#000080">,
        </font>WM_PSD_GREEKTEXTRECT<font color="#000080">,
        </font>WM_PSD_ENVSTAMPRECT<font color="#000080">,
        </font>WM_PSD_YAFULLPAGERECT<font color="#000080">:
          </font><font color="#FF0000"><b>begin
            if </b></font>LParam <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
              </b></font>PaintRect <font color="#000080">:= </font>PRect<font color="#000080">(</font>LParam<font color="#000080">)^
            </font><font color="#FF0000"><b>else
              </b></font>PaintRect <font color="#000080">:= </font>Rect<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
            </font>PaintCanvas <font color="#000080">:= </font>TCanvas<font color="#000080">.</font>Create<font color="#000080">;
            </font>PaintCanvas<font color="#000080">.</font>Handle <font color="#000080">:= </font>HDC<font color="#000080">(</font>WParam<font color="#000080">);
            </font><font color="#FF0000"><b>try
              </b></font>Result <font color="#000080">:= </font>Ord<font color="#000080">(</font>PageSetupDialog<font color="#000080">.</font>FOnPaintPage<font color="#000080">(</font>PageSetupDialog<font color="#000080">,
                                   </font>PagePaintWhat<font color="#000080">[</font>Msg<font color="#000080">], </font>PaintCanvas<font color="#000080">, </font>PaintRect<font color="#000080">));
            </font><font color="#FF0000"><b>finally
              </b></font>PaintCanvas<font color="#000080">.</font>Free<font color="#000080">;   </font><font color="#008000"><i>{ This better not be deleting the DC! }
            </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
          </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>else
        </b></font>Result <font color="#000080">:= </font>DialogHook<font color="#000080">(</font>Wnd<font color="#000080">, </font>Msg<font color="#000080">, </font>wParam<font color="#000080">, </font>lParam<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end else
      </b></font>Result <font color="#000080">:= </font>DialogHook<font color="#000080">(</font>Wnd<font color="#000080">, </font>Msg<font color="#000080">, </font>wParam<font color="#000080">, </font>lParam<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>constructor </b></font>TPageSetupDialog<font color="#000080">.</font>Create<font color="#000080">(</font>AOwner<font color="#000080">: </font>TComponent<font color="#000080">);
</font><font color="#FF0000"><b>begin
  inherited </b></font>Create<font color="#000080">(</font>AOwner<font color="#000080">);
  </font>FOptions <font color="#000080">:= [</font>poDefaultMinMargins<font color="#000080">, </font>poShowHelp<font color="#000080">];
  </font>FOnPrinter <font color="#000080">:= </font><font color="#FF0000"><b>NIL</b></font><font color="#000080">;
  </font>FOnInitPaintPage <font color="#000080">:= </font><font color="#FF0000"><b>NIL</b></font><font color="#000080">;
  </font>FOnPaintPage <font color="#000080">:= </font><font color="#FF0000"><b>NIL</b></font><font color="#000080">;
  </font>FCustomData <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font>FPaperSize <font color="#000080">:= </font>Point<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
  </font>FMinimumMargins <font color="#000080">:= </font>Rect<font color="#000080">(</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">,</font><font color="#800000">0</font><font color="#000080">);
  </font>FMargins <font color="#000080">:= </font>Rect<font color="#000080">(</font><font color="#800000">1000</font><font color="#000080">,</font><font color="#800000">1000</font><font color="#000080">,</font><font color="#800000">1000</font><font color="#000080">,</font><font color="#800000">1000</font><font color="#000080">);
  </font>FMeasurements <font color="#000080">:= </font>pmInches<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>destructor </b></font>TPageSetupDialog<font color="#000080">.</font>Destroy<font color="#000080">;
</font><font color="#FF0000"><b>begin
  inherited </b></font>Destroy<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>procedure </b></font>GetPrinter<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>DeviceMode<font color="#000080">, </font>DeviceNames<font color="#000080">: </font>THandle<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>Device<font color="#000080">, </font>Driver<font color="#000080">, </font>Port<font color="#000080">: </font><font color="#FF0000"><b>array</b></font><font color="#000080">[</font><font color="#800000">0</font><font color="#000080">..</font><font color="#800000">79</font><font color="#000080">] </font><font color="#FF0000"><b>of </b></font>char<font color="#000080">;
  </font>DevNames<font color="#000080">: </font>PDevNames<font color="#000080">;
  </font>Offset<font color="#000080">: </font>PChar<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Printer<font color="#000080">.</font>GetPrinter<font color="#000080">(</font>Device<font color="#000080">, </font>Driver<font color="#000080">, </font>Port<font color="#000080">, </font>DeviceMode<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>DeviceMode <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
  begin
    </b></font>DeviceNames <font color="#000080">:= </font>GlobalAlloc<font color="#000080">(</font>GHND<font color="#000080">, </font>SizeOf<font color="#000080">(</font>TDevNames<font color="#000080">) +
     </font>StrLen<font color="#000080">(</font>Device<font color="#000080">) + </font>StrLen<font color="#000080">(</font>Driver<font color="#000080">) + </font>StrLen<font color="#000080">(</font>Port<font color="#000080">) + </font><font color="#800000">3</font><font color="#000080">);
    </font>DevNames <font color="#000080">:= </font>PDevNames<font color="#000080">(</font>GlobalLock<font color="#000080">(</font>DeviceNames<font color="#000080">));
    </font><font color="#FF0000"><b>try
      </b></font>Offset <font color="#000080">:= </font>PChar<font color="#000080">(</font>DevNames<font color="#000080">) + </font>SizeOf<font color="#000080">(</font>TDevnames<font color="#000080">);
      </font><font color="#FF0000"><b>with </b></font>DevNames<font color="#000080">^ </font><font color="#FF0000"><b>do
      begin
        </b></font>wDriverOffset <font color="#000080">:= </font>Longint<font color="#000080">(</font>Offset<font color="#000080">) - </font>Longint<font color="#000080">(</font>DevNames<font color="#000080">);
        </font>Offset <font color="#000080">:= </font>StrECopy<font color="#000080">(</font>Offset<font color="#000080">, </font>Driver<font color="#000080">) + </font><font color="#800000">1</font><font color="#000080">;
        </font>wDeviceOffset <font color="#000080">:= </font>Longint<font color="#000080">(</font>Offset<font color="#000080">) - </font>Longint<font color="#000080">(</font>DevNames<font color="#000080">);
        </font>Offset <font color="#000080">:= </font>StrECopy<font color="#000080">(</font>Offset<font color="#000080">, </font>Device<font color="#000080">) + </font><font color="#800000">1</font><font color="#000080">;
        </font>wOutputOffset <font color="#000080">:= </font>Longint<font color="#000080">(</font>Offset<font color="#000080">) - </font>Longint<font color="#000080">(</font>DevNames<font color="#000080">);;
        </font>StrCopy<font color="#000080">(</font>Offset<font color="#000080">, </font>Port<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>finally
      </b></font>GlobalUnlock<font color="#000080">(</font>DeviceNames<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>SetPrinter<font color="#000080">(</font>DeviceMode<font color="#000080">, </font>DeviceNames<font color="#000080">: </font>THandle<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>DevNames<font color="#000080">: </font>PDevNames<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>DevNames <font color="#000080">:= </font>PDevNames<font color="#000080">(</font>GlobalLock<font color="#000080">(</font>DeviceNames<font color="#000080">));
  </font><font color="#FF0000"><b>try
    with </b></font>DevNames<font color="#000080">^ </font><font color="#FF0000"><b>do
      </b></font>Printer<font color="#000080">.</font>SetPrinter<font color="#000080">(</font>PChar<font color="#000080">(</font>DevNames<font color="#000080">) + </font>wDeviceOffset<font color="#000080">,
        </font>PChar<font color="#000080">(</font>DevNames<font color="#000080">) + </font>wDriverOffset<font color="#000080">,
        </font>PChar<font color="#000080">(</font>DevNames<font color="#000080">) + </font>wOutputOffset<font color="#000080">, </font>DeviceMode<font color="#000080">);
  </font><font color="#FF0000"><b>finally
    </b></font>GlobalUnlock<font color="#000080">(</font>DeviceNames<font color="#000080">);
    </font>GlobalFree<font color="#000080">(</font>DeviceNames<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>CopyData<font color="#000080">(</font>Handle<font color="#000080">: </font>THandle<font color="#000080">): </font>THandle<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>Src<font color="#000080">, </font>Dest<font color="#000080">: </font>PChar<font color="#000080">;
  </font>Size<font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font>Handle <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
  begin
    </b></font>Size <font color="#000080">:= </font>GlobalSize<font color="#000080">(</font>Handle<font color="#000080">);
    </font>Result <font color="#000080">:= </font>GlobalAlloc<font color="#000080">(</font>GHND<font color="#000080">, </font>Size<font color="#000080">);
    </font><font color="#FF0000"><b>if </b></font>Result <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
      try
        </b></font>Src <font color="#000080">:= </font>GlobalLock<font color="#000080">(</font>Handle<font color="#000080">);
        </font>Dest <font color="#000080">:= </font>GlobalLock<font color="#000080">(</font>Result<font color="#000080">);
        </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>Src <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil</b></font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>Dest <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil</b></font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font>Move<font color="#000080">(</font>Src<font color="#000080">^, </font>Dest<font color="#000080">^, </font>Size<font color="#000080">);
      </font><font color="#FF0000"><b>finally
        </b></font>GlobalUnlock<font color="#000080">(</font>Handle<font color="#000080">);
        </font>GlobalUnlock<font color="#000080">(</font>Result<font color="#000080">);
      </font><font color="#FF0000"><b>end
  end
  else </b></font>Result <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>TPageSetupDialog<font color="#000080">.</font>DoExecute<font color="#000080">(</font>Func<font color="#000080">: </font>pointer<font color="#000080">): </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>const
  </b></font>PageSetupOptions<font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font>TPageSetupOption<font color="#000080">] </font><font color="#FF0000"><b>of </b></font>DWORD <font color="#000080">= (
      </font>PSD_DEFAULTMINMARGINS<font color="#000080">, </font>PSD_DISABLEMARGINS<font color="#000080">, </font>PSD_DISABLEORIENTATION<font color="#000080">,
      </font>PSD_DISABLEPAGEPAINTING<font color="#000080">, </font>PSD_DISABLEPAPER<font color="#000080">, </font>PSD_DISABLEPRINTER<font color="#000080">,
      </font>PSD_NOWARNING<font color="#000080">, </font>PSD_SHOWHELP
    <font color="#000080">);
  </font>PageSetupMeasurements<font color="#000080">: </font><font color="#FF0000"><b>array </b></font><font color="#000080">[</font>TPSMeasurements<font color="#000080">] </font><font color="#FF0000"><b>of </b></font>DWORD <font color="#000080">= (
      </font>PSD_INHUNDREDTHSOFMILLIMETERS<font color="#000080">, </font>PSD_INTHOUSANDTHSOFINCHES
    <font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>Option<font color="#000080">: </font>TPageSetupOption<font color="#000080">;
  </font>PageSetup<font color="#000080">: </font>TPageSetupDlg<font color="#000080">;
  </font>SavePageSetupDialog<font color="#000080">: </font>TPageSetupDialog<font color="#000080">;
  </font>DevHandle<font color="#000080">: </font>THandle<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>FillChar<font color="#000080">(</font>PageSetup<font color="#000080">, </font>SizeOf<font color="#000080">(</font>PageSetup<font color="#000080">), </font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>with </b></font>PageSetup <font color="#FF0000"><b>do
  try
    </b></font>lStructSize <font color="#000080">:= </font>SizeOf<font color="#000080">(</font>TPageSetupDlg<font color="#000080">);
    </font>hInstance <font color="#000080">:= </font>System<font color="#000080">.</font>HInstance<font color="#000080">;

    </font>Flags <font color="#000080">:= </font>PSD_MARGINS<font color="#000080">;

    </font><font color="#FF0000"><b>if </b></font>assigned<font color="#000080">(</font>FOnPrinter<font color="#000080">) </font><font color="#FF0000"><b>or </b></font>assigned<font color="#000080">(</font>FOnInitPaintPage<font color="#000080">) </font><font color="#FF0000"><b>or </b></font>assigned<font color="#000080">(</font>FOnPaintPage<font color="#000080">) </font><font color="#FF0000"><b>then begin
      </b></font>Flags <font color="#000080">:= </font>Flags <font color="#FF0000"><b>or </b></font>PSD_ENABLEPAGESETUPHOOK<font color="#000080">;
      </font>lpfnPageSetupHook <font color="#000080">:= </font>PageSetupDialogHook<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

    </font><font color="#FF0000"><b>for </b></font>Option <font color="#000080">:= </font>Low<font color="#000080">(</font>Option<font color="#000080">) </font><font color="#FF0000"><b>to </b></font>High<font color="#000080">(</font>Option<font color="#000080">) </font><font color="#FF0000"><b>do
      if </b></font>Option <font color="#FF0000"><b>in </b></font>FOptions <font color="#FF0000"><b>then
        </b></font>Flags <font color="#000080">:= </font>Flags <font color="#FF0000"><b>OR </b></font>PageSetupOptions<font color="#000080">[</font>Option<font color="#000080">];
    </font>Flags <font color="#000080">:= </font>Flags <font color="#FF0000"><b>OR </b></font>PageSetupMeasurements<font color="#000080">[</font>FMeasurements<font color="#000080">];
</font><font color="#008000"><i>{    if not assigned(FOnPrinter) then
      Flags := Flags OR PSD_DISABLEPRINTER;}
    </i></font><font color="#FF0000"><b>if </b></font>assigned<font color="#000080">(</font>FOnInitPaintPage<font color="#000080">) </font><font color="#FF0000"><b>and </b></font>assigned<font color="#000080">(</font>FOnPaintPage<font color="#000080">) </font><font color="#FF0000"><b>then begin
      </b></font>Flags <font color="#000080">:= </font>Flags <font color="#FF0000"><b>OR </b></font>PSD_ENABLEPAGEPAINTHOOK<font color="#000080">;
      </font>lpfnPagePaintHook <font color="#000080">:= </font>PageSetupDialogHook<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

    </font>hWndOwner <font color="#000080">:= </font>Application<font color="#000080">.</font>Handle<font color="#000080">;
    </font>GetPrinter<font color="#000080">(</font>DevHandle<font color="#000080">, </font>hDevNames<font color="#000080">);
    </font>hDevMode <font color="#000080">:= </font>CopyData<font color="#000080">(</font>DevHandle<font color="#000080">);
    </font>HookCtl3D <font color="#000080">:= </font>Ctl3D<font color="#000080">;
    </font>lCustData <font color="#000080">:= </font>FCustomData<font color="#000080">;
    </font>ptPaperSize <font color="#000080">:= </font>FPaperSize<font color="#000080">;
    </font>rtMinMargin <font color="#000080">:= </font>FMinimumMargins<font color="#000080">;
    </font>rtMargin <font color="#000080">:= </font>FMargins<font color="#000080">;

    </font>SavePageSetupDialog <font color="#000080">:= </font>PageSetupDialog<font color="#000080">;
    </font>PageSetupDialog <font color="#000080">:= </font>Self<font color="#000080">;
    </font>Result <font color="#000080">:= </font>TaskModalDialog<font color="#000080">(</font>Func<font color="#000080">, </font>PageSetup<font color="#000080">);
    </font>PageSetupDialog <font color="#000080">:= </font>SavePageSetupDialog<font color="#000080">;

    </font><font color="#FF0000"><b>if </b></font>Result <font color="#FF0000"><b>then begin
      </b></font>FPaperSize <font color="#000080">:= </font>ptPaperSize<font color="#000080">;
      </font>FMinimumMargins <font color="#000080">:= </font>rtMinMargin<font color="#000080">;
      </font>FMargins <font color="#000080">:= </font>rtMargin<font color="#000080">;
      </font>SetPrinter<font color="#000080">(</font>hDevMode<font color="#000080">, </font>hDevNames<font color="#000080">);
    </font><font color="#FF0000"><b>end else begin
      if </b></font>hDevMode <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>GlobalFree<font color="#000080">(</font>hDevMode<font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>hDevNames <font color="#000080">&lt;&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then </b></font>GlobalFree<font color="#000080">(</font>hDevNames<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>finally
    </b></font><font color="#008000"><i>{ Nothing yet }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>TPageSetupDialog<font color="#000080">.</font>Execute<font color="#000080">: </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Result <font color="#000080">:= </font>DoExecute<font color="#000080">(@</font>PageSetupDlg<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>TPageSetupDialog<font color="#000080">.</font>Printer<font color="#000080">(</font>Wnd<font color="#000080">: </font>HWND<font color="#000080">): </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Result <font color="#000080">:=  </font>assigned<font color="#000080">(</font>FOnPrinter<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font>Result <font color="#FF0000"><b>then
    </b></font>FOnPrinter<font color="#000080">(</font>Self<font color="#000080">, </font>Wnd<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>TPageSetupDialog<font color="#000080">.</font>DoPrinter<font color="#000080">(</font>Wnd<font color="#000080">: </font>HWND<font color="#000080">): </font>boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  try
    </b></font>Result <font color="#000080">:= </font>Printer<font color="#000080">(</font>Wnd<font color="#000080">);
  </font><font color="#FF0000"><b>except
    </b></font>Result <font color="#000080">:= </font>FALSE<font color="#000080">;
    </font>Application<font color="#000080">.</font>HandleException<font color="#000080">(</font>Self<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#FF0000"><b>procedure Register</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{ You may prefer it on the Dialogs page, I like it on Win95 because it is }
  { only available on Win95.                                                }
  </i></font>RegisterComponents<font color="#000080">(</font><font color="#800000">'Win95'</font><font color="#000080">, [</font>TPageSetupDialog<font color="#000080">]);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>{ Initialization and cleanup }

</i></font><font color="#FF0000"><b>procedure </b></font>InitGlobals<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>HelpMsg <font color="#000080">:= </font>RegisterWindowMessage<font color="#000080">(</font>HelpMsgString<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>initialization
  </b></font>InitGlobals<font color="#000080">;
</font><font color="#FF0000"><b>finalization
  </b></font><font color="#008000"><i>{ Nothing }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">.

</font><font color="#008000"><i>{ { ------------------------- snip, snip ----------------------------}

ENCODED PGSETUP.DCR FILE REMOVED.  PLEASE <A HREF="0284.ATTACH.ZIP">DOWNLOAD</A> EITHER THE 
ATTACHMENT OR THE COMPLETE ZIP FILE.

{------------------------- snip, snip ----------------------------}

ENCODED DEMO.ZIP FILE REMOVED.  PLEASE <A HREF="0284.ATTACH.ZIP">DOWNLOAD</A> EITHER THE 
ATTACHMENT OR THE COMPLETE ZIP FILE.
</i>
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to DELPHI SWAG index</a><b>]</b>&nbsp;&nbsp;
<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;
<b>[</b><a href="0284.PAS">Original</a><b>]</b>&nbsp;&nbsp;
<b>[</b><a href="0284.ATTACH.ZIP">Attachment</a><b>]</b>
</p></body>
</html>
